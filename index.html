<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSB ¬∑ OTP Bulletin Board</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=Sarabun:wght@300;400;600;700&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161920;
    --surface2: #1e2230;
    --border: #2a2f40;
    --text: #e2e6f0;
    --text-muted: #6b7494;
    --text-dim: #3d4460;
    --accent: #4f8ef7;
    --accent-glow: rgba(79,142,247,0.15);
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'Sarabun', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  /* ====== HEADER ====== */
  header {
    position: relative;
    z-index: 10;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: var(--accent);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-weight: 700;
    font-size: 14px;
    color: white;
    letter-spacing: -1px;
    flex-shrink: 0;
  }

  .logo-text {
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0.05em;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 400;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .clock {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--text-muted);
  }

  .refresh-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--mono);
  }

  .refresh-badge:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .pulse-dot {
    width: 7px;
    height: 7px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 2s ease infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* ====== MAIN ====== */
  main {
    position: relative;
    z-index: 1;
    max-width: 1280px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  .page-title {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 8px;
  }

  .page-title h1 {
    font-family: var(--mono);
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.02em;
  }

  .page-title .tag {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--accent);
    background: var(--accent-glow);
    border: 1px solid rgba(79,142,247,0.3);
    border-radius: 4px;
    padding: 2px 8px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .page-subtitle {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 28px;
  }

  /* ====== FILTER BAR ====== */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .filter-btn {
    font-family: var(--mono);
    font-size: 12px;
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.04em;
  }

  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }

  .filter-spacer { flex: 1; }

  .search-box {
    font-family: var(--mono);
    font-size: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    color: var(--text);
    outline: none;
    width: 220px;
    transition: border-color 0.2s;
  }

  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--text-dim); }

  /* ====== CARDS GRID ====== */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 16px;
  }

  /* ====== OTP CARD ====== */
  .otp-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.25s, box-shadow 0.25s;
    animation: cardIn 0.4s ease both;
  }

  .otp-card:hover {
    border-color: rgba(79,142,247,0.4);
    box-shadow: 0 0 0 1px rgba(79,142,247,0.1), 0 8px 32px rgba(0,0,0,0.4);
  }

  .otp-card.expired {
    opacity: 0.5;
    filter: grayscale(0.4);
  }

  .otp-card.no-code {
    border-style: dashed;
    opacity: 0.6;
  }

  @keyframes cardIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Card top strip - color coded */
  .card-strip {
    height: 3px;
    width: 100%;
  }

  /* Card header */
  .card-header {
    padding: 16px 18px 12px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .system-badge {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .system-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }

  .system-info {}
  .system-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.2;
  }

  .system-from {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 180px;
  }

  .status-chip {
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    flex-shrink: 0;
  }

  .status-chip.active   { background: rgba(34,197,94,0.15); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
  .status-chip.warning  { background: rgba(245,158,11,0.15); color: var(--warning); border: 1px solid rgba(245,158,11,0.3); }
  .status-chip.expired  { background: rgba(239,68,68,0.12);  color: var(--danger);  border: 1px solid rgba(239,68,68,0.2); }
  .status-chip.nocode   { background: rgba(107,116,148,0.15); color: var(--text-muted); border: 1px solid var(--border); }

  /* OTP Code section */
  .code-section {
    margin: 4px 18px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
    overflow: hidden;
  }

  .code-section::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 60%, var(--accent-glow));
    pointer-events: none;
  }

  .code-section:hover { background: #232840; }

  .no-code-section {
    margin: 4px 18px 14px;
    background: var(--surface2);
    border: 1px dashed var(--border);
    border-radius: 8px;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 12px;
  }

  .otp-digits {
    font-family: var(--mono);
    font-size: 32px;
    font-weight: 700;
    letter-spacing: 0.15em;
    color: var(--text);
    line-height: 1;
  }

  .copy-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .copy-btn:hover { background: var(--border); color: var(--accent); }
  .copy-btn.copied { color: var(--success); }

  /* Expiry / countdown */
  .expiry-bar {
    padding: 0 18px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .expiry-icon { font-size: 13px; }

  .countdown-wrap { flex: 1; }

  .countdown-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .progress-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 1s linear;
  }

  .progress-fill.safe    { background: var(--success); }
  .progress-fill.caution { background: var(--warning); }
  .progress-fill.urgent  { background: var(--danger); animation: blink 0.8s ease infinite; }

  @keyframes blink {
    0%,100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .countdown-time {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 600;
    min-width: 60px;
    text-align: right;
  }

  .countdown-time.safe    { color: var(--success); }
  .countdown-time.caution { color: var(--warning); }
  .countdown-time.urgent  { color: var(--danger); }
  .countdown-time.expired { color: var(--text-dim); }

  /* Card footer */
  .card-footer {
    border-top: 1px solid var(--border);
    padding: 10px 18px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .meta-item { display: flex; flex-direction: column; gap: 1px; }
  .meta-label {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .meta-value {
    font-size: 11px;
    color: var(--text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ====== EMPTY STATE ====== */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px 40px;
    color: var(--text-muted);
  }

  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
  .empty-state h3 { font-family: var(--mono); font-size: 16px; margin-bottom: 8px; }
  .empty-state p { font-size: 13px; color: var(--text-dim); }

  /* ====== TOAST ====== */
  #toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface2);
    border: 1px solid var(--success);
    color: var(--success);
    font-family: var(--mono);
    font-size: 13px;
    padding: 10px 18px;
    border-radius: 8px;
    z-index: 1000;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }

  #toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  /* ====== STATS BAR ====== */
  .stats-bar {
    display: flex;
    gap: 24px;
    margin-bottom: 24px;
    padding: 14px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    flex-wrap: wrap;
  }

  .stat-item { display: flex; flex-direction: column; gap: 2px; }
  .stat-val {
    font-family: var(--mono);
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  .stat-val.green { color: var(--success); }
  .stat-val.orange { color: var(--warning); }
  .stat-val.red { color: var(--danger); }
  .stat-key {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .stat-divider { width: 1px; background: var(--border); align-self: stretch; }

  /* ====== RESPONSIVE ====== */
  @media (max-width: 600px) {
    .cards-grid { grid-template-columns: 1fr; }
    header { padding: 0 16px; }
    main { padding: 20px 16px; }
    .otp-digits { font-size: 26px; }
  }

  /* Demo badge */
  .demo-notice {
    background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.3);
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 12px;
    color: var(--warning);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">DS<br>B</div>
    <div>
      <div class="logo-text">OTP BULLETIN BOARD</div>
      <div class="logo-sub">Domnern Somgiat &amp; Boonma Law Office</div>
    </div>
  </div>
  <div class="header-right">
    <span class="clock" id="clock">--:--:--</span>
    <div class="refresh-badge" onclick="loadData()">
      <span class="pulse-dot"></span>
      <span id="refresh-label">LIVE</span>
    </div>
  </div>
</header>

<!-- MAIN -->
<main>
  <div class="page-title">
    <h1>OTP Codes</h1>
    <span class="tag">Secure Access</span>
  </div>
  <p class="page-subtitle">‡∏£‡∏´‡∏±‡∏™ OTP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö DN-Online ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äî ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

  <!-- Demo notice - remove when using real data -->
  <div class="demo-notice" id="demo-notice">
    ‚ö†Ô∏è ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å demo JSON ‚Äî ‡πÄ‡∏°‡∏∑‡πà‡∏≠ deploy ‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ <code>DATA_URL</code> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <code>otp_data.json</code> ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-val" id="stat-total">0</div>
      <div class="stat-key">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-val green" id="stat-active">0</div>
      <div class="stat-key">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-val orange" id="stat-expiring">0</div>
      <div class="stat-key">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-val red" id="stat-expired">0</div>
      <div class="stat-key">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-val" id="stat-updated" style="font-size:12px;margin-top:4px;">‚Äî</div>
      <div class="stat-key">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="filter-btn" data-filter="active" onclick="setFilter('active',this)">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</button>
    <button class="filter-btn" data-filter="expired" onclick="setFilter('expired',this)">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</button>
    <div class="filter-spacer"></div>
    <input class="search-box" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ system / email..." id="search-input" oninput="renderCards()">
  </div>

  <!-- Cards -->
  <div class="cards-grid" id="cards-grid">
    <div class="empty-state">
      <div class="icon">üì≠</div>
      <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
      <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OTP</p>
    </div>
  </div>
</main>

<!-- Toast -->
<div id="toast">‚úì ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP ‡πÅ‡∏•‡πâ‡∏ß</div>

<script>
// ==============================================
// CONFIG
// ==============================================
// ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå otp_data.json ‡∏ó‡∏µ‡πà parser ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Pages: ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á raw JSON
// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö local: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô './otp_data.json'
const DATA_URL = './otp_data.json';
const REFRESH_INTERVAL_MS = 60000; // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ

// ==============================================

let allData = [];
let currentFilter = 'all';

// ---- Demo data (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) ----
const DEMO_DATA = [
  {
    id: "demo1",
    from_email: "ascentsupport@doelegal.com",
    to_email: "rutorn@dsb.co.th",
    subject: "ASCENT - Authentication Request Token 143310",
    received_at: new Date(Date.now() - 5 * 60000).toISOString(),
    otp_code: "143310",
    expiry_str: "30 minutes",
    expiry_minutes: 30,
    expires_at: new Date(Date.now() + 25 * 60000).toISOString(),
    system_name: "ASCENT (DOE Legal)",
    system_url: "http://ascent.doelegal.com",
    color: "#1a56db",
  },
  {
    id: "demo2",
    from_email: "no-reply@lexisnexis.com",
    to_email: "rutorn@dsb.co.th",
    subject: "CounselLink Multi-factor Authentication Verification Code",
    received_at: new Date(Date.now() - 8 * 60000).toISOString(),
    otp_code: "193233",
    expiry_str: "10 minutes",
    expiry_minutes: 10,
    expires_at: new Date(Date.now() + 2 * 60000).toISOString(),
    system_name: "CounselLink (LexisNexis)",
    system_url: "https://counsellink.com",
    color: "#d61f1f",
  },
  {
    id: "demo3",
    from_email: "noreply@someservice.com",
    to_email: "rutorn@dsb.co.th",
    subject: "Your OTP Code",
    received_at: new Date(Date.now() - 40 * 60000).toISOString(),
    otp_code: "827461",
    expiry_str: "15 minutes",
    expiry_minutes: 15,
    expires_at: new Date(Date.now() - 25 * 60000).toISOString(),
    system_name: "Generic System",
    system_url: "",
    color: "#6b7280",
  },
];

// ---- Helpers ----
function getExpiryState(item) {
  if (!item.expires_at) return { state: 'noexp', pct: 100, remaining: null };
  const now = Date.now();
  const exp = new Date(item.expires_at).getTime();
  const rcv = new Date(item.received_at).getTime();
  const total = exp - rcv;
  const remaining = exp - now;

  if (remaining <= 0) return { state: 'expired', pct: 0, remaining: 0 };
  const pct = Math.max(0, Math.min(100, (remaining / total) * 100));
  const state = pct > 40 ? 'safe' : pct > 15 ? 'caution' : 'urgent';
  return { state, pct, remaining };
}

function formatRemaining(ms) {
  if (ms <= 0) return '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
  const sec = Math.floor(ms / 1000);
  if (sec < 60) return `${sec}s`;
  const min = Math.floor(sec / 60);
  const s = sec % 60;
  if (min < 60) return `${min}m ${s}s`;
  const hr = Math.floor(min / 60);
  const m = min % 60;
  return `${hr}h ${m}m`;
}

function formatDate(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' }) +
    ' ' + d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
}

function getInitials(name) {
  return name.split(/[\s\(\)]+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// ---- Build card HTML ----
function buildCard(item) {
  const { state, pct, remaining } = getExpiryState(item);
  const expired = state === 'expired';
  const hasCode = item.otp_code && item.otp_code !== 'null';

  let statusLabel, statusClass;
  if (!hasCode) { statusLabel = 'NO CODE'; statusClass = 'nocode'; }
  else if (expired) { statusLabel = 'EXPIRED'; statusClass = 'expired'; }
  else if (state === 'urgent') { statusLabel = 'URGENT'; statusClass = 'warning'; }
  else { statusLabel = 'ACTIVE'; statusClass = 'active'; }

  const cardClass = ['otp-card', expired ? 'expired' : '', !hasCode ? 'no-code' : ''].join(' ').trim();

  const fromClean = item.from_email.replace(/<[^>]+>/g, '').trim();
  const toClean = item.to_email.replace(/["<>]/g, '').trim();

  let codeSection = '';
  if (hasCode) {
    codeSection = `
      <div class="code-section" onclick="copyCode('${item.otp_code}', this)" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">
        <div class="otp-digits">${item.otp_code}</div>
        <button class="copy-btn" id="copy-${item.id}">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          COPY
        </button>
      </div>`;
  } else {
    codeSection = `
      <div class="no-code-section">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ OTP ‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ
      </div>`;
  }

  let expirySection = '';
  if (item.expiry_minutes && hasCode) {
    const fillClass = expired ? 'expired' : state === 'safe' ? 'safe' : state === 'caution' ? 'caution' : 'urgent';
    const timeClass = expired ? 'expired' : fillClass;
    const timeLabel = expired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : formatRemaining(remaining);
    expirySection = `
      <div class="expiry-bar">
        <span class="expiry-icon">‚è±</span>
        <div class="countdown-wrap">
          <div class="countdown-label">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${item.expiry_str}</div>
          <div class="progress-bar">
            <div class="progress-fill ${fillClass}" id="prog-${item.id}" style="width:${pct}%"></div>
          </div>
        </div>
        <span class="countdown-time ${timeClass}" id="timer-${item.id}">${timeLabel}</span>
      </div>`;
  } else if (!hasCode) {
    expirySection = '';
  } else {
    expirySection = `
      <div class="expiry-bar">
        <span class="expiry-icon">‚àû</span>
        <div class="countdown-wrap"><div class="countdown-label">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div></div>
      </div>`;
  }

  return `
    <div class="${cardClass}" data-id="${item.id}" data-system="${item.system_name}" data-from="${fromClean}" data-code="${item.otp_code || ''}">
      <div class="card-strip" style="background:${item.color || '#4f8ef7'}"></div>
      <div class="card-header">
        <div class="system-badge">
          <div class="system-icon" style="background:${item.color || '#4f8ef7'}">${getInitials(item.system_name)}</div>
          <div class="system-info">
            <div class="system-name">${item.system_name}</div>
            <div class="system-from" title="${fromClean}">${fromClean}</div>
          </div>
        </div>
        <span class="status-chip ${statusClass}">${statusLabel}</span>
      </div>
      ${codeSection}
      ${expirySection}
      <div class="card-footer">
        <div class="meta-item">
          <div class="meta-label">‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á</div>
          <div class="meta-value" title="${toClean}">${toClean.split('@')[0]}</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠</div>
          <div class="meta-value">${formatDate(item.received_at)}</div>
        </div>
        <div class="meta-item" style="grid-column:1/-1">
          <div class="meta-label">Subject</div>
          <div class="meta-value" title="${item.subject}">${item.subject}</div>
        </div>
      </div>
    </div>`;
}

// ---- Copy to clipboard ----
function copyCode(code, el) {
  navigator.clipboard.writeText(code).then(() => {
    const btn = el.querySelector('.copy-btn');
    if (btn) { btn.classList.add('copied'); btn.textContent = '‚úì COPIED'; }
    showToast(`‚úì ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ${code} ‡πÅ‡∏•‡πâ‡∏ß`);
    setTimeout(() => {
      if (btn) { btn.classList.remove('copied'); btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>COPY`; }
    }, 2500);
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ---- Render ----
function renderCards() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const grid = document.getElementById('cards-grid');

  let filtered = allData.filter(item => {
    const { state } = getExpiryState(item);
    if (currentFilter === 'active' && (state === 'expired' || !item.otp_code)) return false;
    if (currentFilter === 'expired' && state !== 'expired') return false;
    if (search) {
      const haystack = [item.system_name, item.from_email, item.to_email, item.subject, item.otp_code].join(' ').toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });

  if (filtered.length === 0) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">üîç</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><p>‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô filter ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p></div>`;
    return;
  }

  grid.innerHTML = filtered.map(buildCard).join('');

  // Update stats
  const total = allData.filter(i => i.otp_code).length;
  const active = allData.filter(i => i.otp_code && getExpiryState(i).state !== 'expired').length;
  const expiring = allData.filter(i => i.otp_code && getExpiryState(i).state === 'urgent').length;
  const expired = allData.filter(i => i.otp_code && getExpiryState(i).state === 'expired').length;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-expiring').textContent = expiring;
  document.getElementById('stat-expired').textContent = expired;
}

// ---- Tick timers ----
function tickTimers() {
  allData.forEach(item => {
    if (!item.otp_code || !item.expiry_minutes) return;
    const { state, pct, remaining } = getExpiryState(item);
    const timerEl = document.getElementById(`timer-${item.id}`);
    const progEl = document.getElementById(`prog-${item.id}`);
    if (!timerEl) return;

    const label = state === 'expired' ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : formatRemaining(remaining);
    timerEl.textContent = label;
    timerEl.className = `countdown-time ${state === 'expired' ? 'expired' : state}`;
    if (progEl) {
      progEl.style.width = pct + '%';
      progEl.className = `progress-fill ${state === 'expired' ? 'expired' : state}`;
    }
  });
}

// ---- Filter ----
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCards();
}

// ---- Load data ----
async function loadData() {
  document.getElementById('refresh-label').textContent = '...';
  try {
    const res = await fetch(DATA_URL + '?t=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    allData = await res.json();
    document.getElementById('demo-notice').style.display = 'none';
  } catch (e) {
    // fallback to demo
    allData = DEMO_DATA;
    console.warn('Using demo data:', e.message);
  }
  document.getElementById('stat-updated').textContent = new Date().toLocaleTimeString('th-TH');
  document.getElementById('refresh-label').textContent = 'LIVE';
  renderCards();
}

// ---- Clock ----
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('th-TH', { hour12: false });
}

// ---- Init ----
window.addEventListener('DOMContentLoaded', () => {
  updateClock();
  setInterval(updateClock, 1000);
  setInterval(tickTimers, 1000);
  setInterval(loadData, REFRESH_INTERVAL_MS);
  loadData();
});
</script>
</body>
</html>
